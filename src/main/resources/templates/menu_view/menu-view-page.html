<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{layouts/layout1}">

<head>
    <meta charset="UTF-8">
    <title>Menu Display</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
        }
        body, h1, h2, h3, p, ul, li {
            margin: 0;
            padding: 0;
        }
        /* Header styles */
        .header {
            background-color: transparent; /* 투명한 배경 */
            /*position: fixed;*/
            width: 100%;
        }

        /* Logo styles */
        .logo {
            position: absolute;
            top: 25px;
            left: 20px;
            color: #333333;
            font-size: 24px;
            font-weight: bold;
        }

        /* Menu styles */
        .menu {
            background-color: #ffffff; /* 헤더 바의 배경색 */
            padding: 30px 0; /* 높이를 높임 */
            border-bottom: 1px solid #e0e0e0;
            text-align: right;
        }

        .menu ul {
            list-style: none;
        }

        .menu ul li {
            display: inline-block;
            margin-right: 80px; /* 메뉴 간격을 조정 */
        }

        .menu ul li a {
            text-decoration: none;
            color: #333333;
            font-weight: bold;
        }
        /* Hover effect */
        .menu ul li a:hover {
            color: #009aff;
        }

        .store-title {
            background-color: transparent;
            width: 100%;
            padding: 10px 0;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-top: 100px;
        }

        .menu-list {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            overflow: hidden;
        }

        .menu-container {
            width: 100%;
        }

        .menu-item {
            display: inline-block;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 230px;
            text-align: center;
            margin: 10px; /* 좌우 간격을 조절하여 간격 설정 */
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .menu-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .menu-item img {
            max-width: 100%;
            height: auto;
        }

        .menu-item h3 {
            font-size: 20px;
            margin: 10px 0;
        }

        .menu-item p {
            font-size: 16px;
            color: #777;
        }

        .menu-item button {
            display: inline-block;
            padding: 5px 10px;
            background-color: black;
            color: #ffffff;
            font-size: 13px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            float: right;
            margin-right: 3%;
        }

        .menu-item span {
            font-weight: bold;
            font-size: 18px;
            color: #333;
        }
        .main-banner {
            width: 100%;
            height: 30vh; /* 화면 높이를 100%로 설정 */
            overflow: hidden; /* 이미지가 벗어나는 부분을 숨김 */
        }

        .main-banner img {
            width: 100%;
            height: 100%; /* 이미지를 부모 요소에 맞게 확대 */
            object-fit: cover; /* 이미지가 잘릴 수 있도록 설정 */
        }

        /* 새로운 스타일 정의 */
        .centered-container {
            display: flex;
            justify-content: flex-end ; /* 우측 정렬 */
            align-items: center; /* 수직 가운데 정렬 */
            width: 100%; /* 전체 너비 차지 */
            height: 80px; /* 원하는 높이 설정 */
        }

        .store-title-input-Box button {
            background-color: #000000; /* 버튼 배경색 지정 */
            color: #fff; /* 버튼 텍스트 색상 지정 */
            border: none; /* 테두리 제거 */
            border-radius: 5px; /* 둥근 모서리 추가 */
            padding: 8px 16px; /* 내부 여백 추가 */
            cursor: pointer;
            transition: background-color 0.3s ease; /* 버튼에 호버 효과 추가 */
        }

        .store-title-input-Box button:hover {
            background-color: #0077cc; /* 호버 시 배경색 변경 */
        }
        #store-name-input-box{
            width: 200px;
            height: 30px;
            border-radius: 5px;
            padding: 4px 8px; /* 내부 여백 추가 */
        }
        .receiptBox {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start; /* 좌측 정렬 */
        }

        .receipt {
            font-family: Arial, sans-serif;
            width: calc(20% - 20px); /* 25% - margin */
            background-color: #fff;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 20px;
            margin-left: 20px;
        }

        .item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .itemName {
            flex: 1;
        }

        .itemPrice {
            flex-shrink: 0;
        }

        .total {
            font-size: 20px;
            font-weight: bold;
            margin-top: 10px;
        }

        .buttonContainer {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .button {
            padding: 10px;
            text-align: center;
            cursor: pointer;
            background-color: #000000;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }

        .cancelButton {
            background-color: #ff1100;
        }
    </style>
</head>
<body>
<div layout:fragment="content">

    <div>
        <div class="store-title">
            [ COFFEE SHOP ] 메뉴
        </div>
        <div class="menu-container" id="menu-container">
            <div class="menu-list" id="menu-list">
            </div>
        </div>
    </div>

    <div class="receiptBox" id="receiptBox">


        <div class="receipt">
            <h2> 주문 목록 </h2>
            <!-- 동적으로 가지고 올 예정 -->
            <div class="item">
                <br>
                주문 상태 업데이트
                <br>
                <br>
                주문 가게: KEP카페

                <br>
                <br>
                [ 주문 메뉴 ]<br>
                - 아메리카노 (2개)<br>
                - 흑당커파 (1개)<br>
                <br>
                <br>
                주문 총 가격: 5500 원
            </div>
            <div class="buttonContainer">
                <button class="button">주문 접수</button>
                <button class="button cancelButton">주문 취소</button>
            </div>

        </div>

    </div>

</div>
<th:block layout:fragment="script">

    <script th:inline="javascript">
        $(document).ready(function () {

            let storeName = [[${storeName}]];

            fetchAndDisplayStoreMenu();
            //다시 데이터를 받아와서 생성

            showStoreName(storeName);


            //동적으로 가게이름 바꾸기 함수
            function showStoreName(store){
                let storeName = $(".store-title");

                let storeNameText = "[ 가게이름 ] 메뉴";

                storeNameText = storeNameText.replace("가게이름", store);

                storeName.text(storeNameText);
            }

            //키오스크 이름 바꾸기 함수

            let currentIndex = 0;
            const itemsPerSlide = 4; // 한 번에 표시할 아이템 수

            function createMenuItems(menuData) {
                const menuList = $("#menu-list")
                menuList.empty(); // 이전 메뉴 삭제;

                for (let i = 0; i < itemsPerSlide; i++) {
                    const index = (currentIndex + i) % menuData.length; // 순환 인덱스 계산
                    const menuItem = menuData[index];

                    const itemDiv = $("<div>").addClass("menu-item");
                    const itemImage = $("<img>").attr("src", menuItem.image).attr("alt", menuItem.name);
                    const itemName = $("<h3>").text(menuItem.name);
                    const itemPrice = $("<span>").text(`${menuItem.price}원`);
                    const itemDescription = $("<p>").text(menuItem.description);
                    const itemReplaceBtn = $("<button>").text("수정").data("menu-id",menuItem.id).attr("class","modify-btn");

                    itemDiv.append(itemImage, itemName, itemPrice, itemDescription, itemReplaceBtn);
                    menuList.append(itemDiv);
                    itemDiv.hide().fadeIn(2000);
                }
                currentIndex = (currentIndex + itemsPerSlide) % menuData.length; // 다음 인덱스 설정
                function menuModifyBtnClickHandler() {
                    const menuBtn = $(".modify-btn");

                    menuBtn.on("click", function () {
                        const menuId = $(this).data("menu-id"); // 현재 클릭된 버튼의 데이터 가져오기

                        location.href = `http://localhost:8080/menu/modify/${menuId}`;
                    });
                }
                menuModifyBtnClickHandler();
            }

            //아이템 정보 입력하는 함수
            function displayMenuItems(data) {
                const menuItems = [];

                for (let i = 0; i < data.length; i++) {
                    let id = data[i].id
                    let name = data[i].name;
                    let price = data[i].price;
                    let description = data[i].description;
                    let image = `/${data[i].storeName}/menuImage/${data[i].image}`; // 상대 경로로 변경

                    const menuItem = {
                        id: id,
                        name: name,
                        price: price,
                        description: description,
                        image: image
                    };
                    console.log(image);
                    menuItems.push(menuItem);
                }

                return menuItems;
            }


            function fetchAndDisplayStoreMenu(storeName){
                $.ajax({
                    type: 'GET',
                    url: `/menu/find-menu-list`,
                    data: { storeName: `${storeName}` }, // storeName 값을 전달
                    dataType: 'json',
                    success: function (data) {
                        let menuData = displayMenuItems(data);
                        createMenuItems(menuData);

                        console.log(menuData);

                        setInterval(function () {
                            $("#menu-list .menu-item").fadeOut(2000, function () {
                                createMenuItems(menuData);
                                $(this).remove();
                            });
                        }, 7000);
                    },
                    error: function (error) {
                        console.log('Ajax 요청 실패:', error);
                    }
                });
            }
        });
    </script>

    <!--소켓 설정-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <script>

        let socket = new SockJS('/websocket-endpoint');
        let stompClient = Stomp.over(socket);
        let orderList = new Array();
        stompClient.connect({}, function(frame) {
            stompClient.subscribe('/menu/', function(message) {
                // 주문 정보 업데이트 처리
                let orderStatus = message.body;
                console.log("주문 상태 업데이트: " + orderStatus);

                orderList.push(orderList);

                updateOrderUI(orderStatus);
            });

        });
        function updateOrderUI(orderInfo) {
            let receipt = document.createElement("div");
            receipt.classList.add("receipt");

            receipt.innerHTML = orderInfo;

            let buttonContainer = document.createElement("div");
            buttonContainer.classList.add("buttonContainer");

            let acceptButton = document.createElement("button");
            acceptButton.classList.add("button");
            acceptButton.textContent = "주문 접수";

            let cancelButton = document.createElement("button");
            cancelButton.classList.add("button", "cancelButton");
            cancelButton.textContent = "주문 취소";

            buttonContainer.appendChild(acceptButton);
            buttonContainer.appendChild(cancelButton);

            receipt.appendChild(buttonContainer);

            let receiptBox = document.getElementById("receiptBox");

            receiptBox.appendChild(receipt);
        }


    </script>
</th:block>
</body>
</html>